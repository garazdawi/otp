# Modernize configurations

## Requirements

* Both per application and per system configurations
** Think of system as a product shipped to customer
* All applications (including erts) should be from the same source
* Testable
** Should be possible by tools to do verification of configuration before start
* Pluggable format
** Allow toml, yaml and etf
* Callbacks on change
* Automatic documentation in edoc and erl_docgen
* Uniform naming scheme

## Open questions

* Do we want runnable configurations?
* What do we do with erts config?

## Things to looks at

* cuttlefish
* elixir config
* init.d vs system.d vs sysctl

## Ideas

* Include description of application parameters in .app file
** Generate a .erl file from this that is the backend for the config
*** In the backend we can either use ets or persistent_term
*** In the backend we can install change hooks and verification
* Should we create an erts application that is also started?
* `will set` vs `did set` callback
* Autogenerated documentation from .app files
* When booting, can we load config early and if it changes something
  that requires a restart we restart the entire emulator with an `exec`?
* Can we remove net load from init?

# TOML Example

## TOML
```
## We can configure erts
[erts.alloc.util]
allocation_strategy = "bestfit"

[erts.alloc.binary]
enabled = false

## We can use both long and short names
[erts.alloc.E]
atags = true

## We can configure the kernel logger
[kernel.logger]
level = "all"

## And add handlers
[[kernel.logger.handler]]
id="file"
module="logger_std_h"
config.file = "log/erlang.log"
config.max_no_files = 5
config.max_no_bytes = 4096

[[kernel.logger.handler.filters]]
id = "remote_gl"
fun = "logger_filters:remote_gl/2"
arg = "stop"

[[kernel.logger.handler]]
id="debug"
module="logger_std_h"
level="debug"
config.file = "log/debug.log"
config.max_no_files = 5
config.max_no_bytes = 4096

```

## Erlang

```
{erts,[{alloc,#{ util => #{ allocation_strategy => "bestfit" },
                  binary => #{ enabled => false },
                  ets => #{ allocator\_tags => true } }}]}.
{kernel,[{logger,#{ level => all,
                    handler => [#{ id => "file", module => "logger_std_h",
                                   config => #{ file => "log/erlang.log",
                                                max_no_files => 5,
                                                max_no_bytes => 4096 },
                                   filters => [#{ id = "remote_gl",
                                                  fun = "logger_filters:remote_gl/2",
                                                  arg = "stop" }] },
                                #{ id => debug,  module => "logger_std_h",
                                   level => debug,
                                   config => #{ file => "log/debug.log",
                                                max_no_files => 5,
                                                max_no_bytes => 4096 }}]
                   }}]}.
```
